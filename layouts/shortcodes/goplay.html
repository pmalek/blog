{{ $id := md5 .Inner }} {{ .Inner }}

<div id="{{ $id }}" class="hugo-goplay-result"></div>
<div class="hugo-goplay-toolbox">
  <button role="button" class="hugo-goplay-button" onclick={{ safeJS (print "goplayRenderCompile_" $id "()") }}>Run</button>
</div>

<style>
  /* .hugo-goplay-result .system {
    color: green;
  }
  .hugo-goplay-result .stderr {
    color: red;
  }
  .hugo-goplay-toolbox {
    display: flex;
    justify-content: flex-start;
    margin-bottom: 2rem;
  }
  .hugo-goplay-toolbox .hugo-goplay-button {
    font-size: 13px;
    font-weight: bold;
    border: 1px solid var(--primary);
    padding: 0.15rem 0.75rem;
    border-radius: 4px;
    margin-left: 0.5rem;
    color: var(--primary);
    background-color: var(--theme);
  }
  .hugo-goplay-toolbox .hugo-goplay-button:hover {
    border: 1px solid var(--theme);
    color: var(--theme);
    background-color: var(--primary);
  }
  .hugo-goplay-toolbox .hugo-goplay-button:first-child {
    margin-left: 0;
  } */
</style>

<script type="module">
// https://ggicci.me/goplay-embed-go-playground-on-your-website/
//   import { GoPlayProxy } from "https://unpkg.com/@ggicci/goplay/dist/index.js";

  var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
const sleep = (n) => new Promise((res) => setTimeout(res, n));
export class GoPlayProxy {
    constructor(proxyUrl = '/goplay') {
        this.proxyUrl = proxyUrl;
    }
    raiseForStatus(resp) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!resp.ok) {
                const message = yield resp.text();
                throw new Error(message ? resp.statusText + ': ' + message : resp.statusText);
            }
        });
    }
    compile(sourceCode, goVersion) {
        return __awaiter(this, void 0, void 0, function* () {
            const form = new FormData();
            form.append('version', '2');
            form.append('withVet', 'true');
            form.append('body', sourceCode);
            const resp = yield fetch(`${this.proxyUrl}/_/compile?backend=${goVersion || ''}`, {
                method: 'POST',
                body: form,
            });
            yield this.raiseForStatus(resp);
            return yield resp.json();
        });
    }
    renderCompile(container, sourceCode, goVersion) {
        return __awaiter(this, void 0, void 0, function* () {
            container.replaceChildren(this.renderMessage('system', 'Waiting for remote server...'));
            const js = yield this.compile(sourceCode, goVersion);
            // Clear output.
            container.replaceChildren();
            // Render build error.
            if (js.Errors != '') {
                container.appendChild(this.renderMessage('error', js.Errors));
                container.appendChild(this.renderMessage('system', '\nGo build failed.'));
                return;
            }
            // Render events.
            for (const event of js.Events || []) {
                container.appendChild(yield this.renderEvent(event));
            }
            container.appendChild(this.renderMessage('system', '\nProgram exited.'));
        });
    }
    renderEvent(e) {
        return __awaiter(this, void 0, void 0, function* () {
            if (e.Delay >= 0) {
                yield sleep(e.Delay / 1000000);
            }
            return this.renderMessage(e.Kind, e.Message);
        });
    }
    renderMessage(kind, message) {
        const output = document.createElement('span');
        output.classList.add(kind);
        output.innerText = message;
        return output;
    }
}
//# sourceMappingURL=index.js.map

//   const goplay = new GoPlayProxy("https://goplay.ggicci.me");
  // const goplay = new GoPlayProxy("http://localhost:8787");
  const goplay = new GoPlayProxy("https://goplayproxy.malekpatryk-cloudflare.workers.dev/");

  function normalizeCode(code) {
    return code
      .trim()
      .replace(/^```go/, "")
      .replace(/^```/, "")
      .replace(/```$/, "")
      .trim();
  }

  const normalizedCode = normalizeCode("{{ .Inner }}")

  window["goplayRenderCompile_" + "{{ $id }}"] = () => {
    const parent = document.getElementById("{{ $id }}")
    const pre = document.createElement('pre')
    const container = document.createElement('code')
    container.classList.add('text')
    pre.appendChild(container)
    parent.replaceChildren(pre)
    goplay.renderCompile(container,normalizedCode);
  };

</script>
